docker-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    # REMOVED: "Create Dockerfile" step - use the real Dockerfile from repo

    - name: Build Docker image
      run: docker build -t myopentelemetryapi:${{ github.sha }} .

    - name: Run Docker container test
      run: |
        docker run -d -p 8080:8080 --name test-container \
          -e ConnectionStrings__DefaultConnection="Host=host.docker.internal;Database=test;Username=test;Password=test" \
          myopentelemetryapi:${{ github.sha }}

        sleep 10
        curl -f http://localhost:8080/api/health || exit 1
        docker logs test-container
        docker stop test-container

    - name: Save Docker image
      if: github.ref == 'refs/heads/main'
      run: |
        docker save myopentelemetryapi:${{ github.sha }} | gzip > myopentelemetryapi.tar.gz

    - name: Upload Docker image
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: myopentelemetryapi.tar.gz
        retention-days: 7
